#!/usr/bin/python
# -*- coding: utf-8 -*-

import sys
import argparse
import time
import json
import os
sys.path.append(os.getcwd() + '/tests/integration')  # NOQA

from google.protobuf import json_format
from ga4gh import genotype_phenotype_pb2 as g2p
from ga4gh import sequence_annotations_pb2 as annotations
from ohsu import g2p_pb2 as evidence

CIVIC_TEST_MESSAGE = """
{"features":[{"entrez_id":1806,"end":97915614,"name":"DPYD*2A HOMOZYGOSITY","start":97915614,"biomarker_type":"splice donor variant","referenceName":"GRCh37","geneSymbol":"DPYD","chromosome":"1"}],"civic":{"evidence_items":[{"status":"accepted","rating":5,"drug_interaction_type":"Substitutes","description":"The Clinical Pharmacogenomics Implementation Consortium Guidelines for DPYD genotype and 5-FU dosing does not recommend the use of 5-FU or capecitabine in patients with homozygous DPYD*2A, *13 or rs67376798 and the FDA drug labels warn to use precautions in this patient population.","open_change_count":0,"evidence_type":"Predictive","drugs":[{"pubchem_id":null,"id":421,"name":"Tegafur"},{"pubchem_id":null,"id":32,"name":"Capecitabine"},{"pubchem_id":null,"id":420,"name":"5-FU"}],"variant_origin":"Germline Polymorphism","disease":{"doid":"162","url":"http://www.disease-ontology.org/?id=DOID:162","display_name":"Cancer","id":216,"name":"Cancer"},"source":{"status":"fully curated","open_access":true,"name":"Clinical Pharmacogenetics Implementation Consortium guidelines for dihydropyrimidine dehydrogenase genotype and fluoropyrimidine dosing.","journal":"Clin. Pharmacol. Ther.","citation":"Caudle et al., 2013, Clin. Pharmacol. Ther.","pmc_id":"PMC3831181","full_journal_title":"Clinical pharmacology and therapeutics","source_url":"http://www.ncbi.nlm.nih.gov/pubmed/23988873","pubmed_id":"23988873","is_review":false,"publication_date":{"month":12,"year":2013},"id":1253},"evidence_direction":"Supports","variant_id":737,"clinical_significance":"Adverse Response","evidence_level":"A","type":"evidence","id":1800,"name":"EID1800"}],"entrez_name":"DPYD","variant_types":[{"display_name":"Splice Donor Variant","description":"A splice variant that changes the 2 base pair region at the 5' end of an intron.","url":"http://www.sequenceontology.org/browser/current_svn/term/SO:0001575","so_id":"SO:0001575","id":41,"name":"splice_donor_variant"}],"description":"","lifecycle_actions":{"last_modified":{"timestamp":"2017-05-31T22:26:46.141Z","order":0,"user":{"username":"CIViC_Bot","area_of_expertise":null,"twitter_handle":"CIViCdb","display_name":"CIViC_Bot","name":"CIViC Bot","bio":null,"url":null,"created_at":"2017-02-20T20:28:47.150Z","avatars":{"x32":"https://secure.gravatar.com/avatar/e990ea7f667d9e4826a1b3127b324018.png?d=identicon&r=pg&s=32","x14":"https://secure.gravatar.com/avatar/e990ea7f667d9e4826a1b3127b324018.png?d=identicon&r=pg&s=14","x64":"https://secure.gravatar.com/avatar/e990ea7f667d9e4826a1b3127b324018.png?d=identicon&r=pg&s=64","x128":"https://secure.gravatar.com/avatar/e990ea7f667d9e4826a1b3127b324018.png?d=identicon&r=pg&s=128"},"orcid":null,"accepted_license":null,"affiliation":null,"avatar_url":"https://secure.gravatar.com/avatar/e990ea7f667d9e4826a1b3127b324018.png?d=identicon&r=pg&s=32","role":"curator","facebook_profile":null,"linkedin_profile":null,"organization":{},"last_seen_at":null,"featured_expert":false,"id":385,"signup_complete":null}},"last_reviewed":{"timestamp":"2017-06-01T21:36:51.756Z","order":1,"user":{"username":"ahwagner","area_of_expertise":"Research Scientist","twitter_handle":"HandlerWagner","display_name":"ahwagner","name":"Alex Handler Wagner, PhD","bio":"Dr. Wagner is an NCI Postdoctoral Fellow training at the McDonnell Genome Institute at Washington University School of Medicine. His research interests are focused on the collaborative clinical interpretation of sequence variants in cancers.","url":"http://alexwagner.info/","created_at":"2015-02-26T15:58:31.729Z","avatars":{"x32":"https://secure.gravatar.com/avatar/5a72d8047067d33487a78092f3bbb09e.png?d=identicon&r=pg&s=32","x14":"https://secure.gravatar.com/avatar/5a72d8047067d33487a78092f3bbb09e.png?d=identicon&r=pg&s=14","x64":"https://secure.gravatar.com/avatar/5a72d8047067d33487a78092f3bbb09e.png?d=identicon&r=pg&s=64","x128":"https://secure.gravatar.com/avatar/5a72d8047067d33487a78092f3bbb09e.png?d=identicon&r=pg&s=128"},"orcid":"0000-0002-2502-8961","accepted_license":null,"affiliation":"","avatar_url":"https://secure.gravatar.com/avatar/5a72d8047067d33487a78092f3bbb09e.png?d=identicon&r=pg&s=32","role":"editor","facebook_profile":"AlexHWagner","linkedin_profile":"alexphd","organization":{"url":"http://genome.wustl.edu/","profile_image":{"x32":"/system/organizations/profile_images/000/000/001/x32/MGI_STANDARD4_logo_brown-example_v1b.png?1494525976","x256":"/system/organizations/profile_images/000/000/001/x256/MGI_STANDARD4_logo_brown-example_v1b.png?1494525976","x14":"/system/organizations/profile_images/000/000/001/x14/MGI_STANDARD4_logo_brown-example_v1b.png?1494525976","x64":"/system/organizations/profile_images/000/000/001/x64/MGI_STANDARD4_logo_brown-example_v1b.png?1494525976","x128":"/system/organizations/profile_images/000/000/001/x128/MGI_STANDARD4_logo_brown-example_v1b.png?1494525976"},"description":"The McDonnell Genome Institute (MGI) is a world leader in the fast-paced, constantly changing field of genomics. A truly unique institution, we are pushing the limits of academic research by creating, testing, and implementing new approaches to the study of biology with the goal of understanding human health and disease, as well as evolution and the biology of other organisms.","name":"The McDonnell Genome Institute","id":1},"last_seen_at":"2017-06-02T15:50:47.714Z","featured_expert":false,"id":7,"signup_complete":null}}},"provisional_values":{},"gene_id":1526,"name":"DPYD*2A HOMOZYGOSITY","variant_groups":[],"sources":[],"entrez_id":1806,"variant_aliases":["RS3918290","DPYD*2A","DPYD:IVS14 + 1G>A","C.1905+1G>A"],"hgvs_expressions":["NC_000001.10:g.97915614C>T"],"errors":{},"coordinates":{"chromosome2":null,"reference_bases":"C","start2":null,"variant_bases":"T","stop":97915614,"stop2":null,"representative_transcript2":null,"start":97915614,"representative_transcript":"ENST00000370192.3","ensembl_version":75,"chromosome":"1","reference_build":"GRCh37"},"type":"variant","id":737,"clinvar_entries":["432"]},"genes":["DPYD"],"dev_tags":[],"source":"civic","tags":[],"feature_names":"EID1800","association":{"drug_labels":"Tegafur,Capecitabine,5-Fluorouracil","description":"The Clinical Pharmacogenomics Implementation Consortium Guidelines for DPYD genotype and 5-FU dosing does not recommend the use of 5-FU or capecitabine in patients with homozygous DPYD*2A, *13 or rs67376798 and the FDA drug labels warn to use precautions in this patient population.","publication_url":["http://www.ncbi.nlm.nih.gov/pubmed/23988873"],"evidence":[{"info":{"publications":["http://www.ncbi.nlm.nih.gov/pubmed/23988873"]},"evidenceType":{"sourceName":"CIVIC","id":"1800"},"description":"Adverse Response"}],"environmentalContexts":[{"taxonomy":{"kingdom":"Organic compounds","direct-parent":"Halopyrimidines","class":"Diazines","subclass":"Pyrimidines and pyrimidine derivatives","superclass":"Organoheterocyclic compounds"},"term":"Tegafur","id":"compound:CID5386","description":"Tegafur"},{"taxonomy":{"kingdom":"Organic compounds","direct-parent":"Glycosylamines","class":"Carbohydrates and carbohydrate conjugates","subclass":"Glycosyl compounds","superclass":"Organooxygen compounds"},"term":"Capecitabine","approved_countries":["Canada","US"],"id":"compound:CID60953","description":"Capecitabine"},{"term":"5-Fluorouracil","id":"compound:CID3385","description":"5-Fluorouracil"}],"evidence_label":"A","phenotype":{"type":{"term":"cancer","id":"DOID:162"},"description":"cancer","id":"http://www.disease-ontology.org/?id=DOID:162"},"evidence_level":1,"response_type":"Adverse Response"}}
"""  # NOQA

JAX_TEST_MESSAGE = """
{"features":[{"geneSymbol":"KRAS","name":"KRAS","biomarker_type":"g13x"}],"jax":{"approval_status":"FDA approved","evidence_type":"Actionable","indication_tumor_type":"lung adenocarcinoma","references":["15696205"],"response_type":"resistant","efficacy_evidence":"In clinical studies, lung adenocarcinoma patients with KRAS codon 12 or 13 mutations lack sensitivity to Iressa (gefitinib) (PMID: 15696205).","molecular_profile":"KRAS G13X","therapy_name":"Gefitinib"},"tags":[],"genes":["KRAS"],"source":"jax","dev_tags":[],"feature_names":"KRAS G13X","association":{"drug_labels":"Gefitinib","description":"In clinical studies, lung adenocarcinoma patients with KRAS codon 12 or 13 mutations lack sensitivity to Iressa (gefitinib) (PMID: 15696205).","publication_url":"http://www.ncbi.nlm.nih.gov/pubmed/15696205","evidence":[{"info":{"publications":[["http://www.ncbi.nlm.nih.gov/pubmed/15696205"]]},"evidenceType":{"sourceName":"jax"},"description":"resistant"}],"environmentalContexts":[{"term":"Gefitinib","description":"Gefitinib","taxonomy":{"kingdom":"Organic compounds","direct-parent":"Quinazolinamines","class":"Naphthyridines","subclass":"Quinazolines","superclass":"Organoheterocyclic compounds"},"toxicity":"The acute toxicity of gefitinib up to 500 mg in clinical studies has been low. In non-clinical studies, a single dose of 12,000 mg/m<sup>2</sup> (about 80 times the recommended clinical dose on a mg/m<sup>2</sup> basis) was lethal to rats. Half this dose caused no mortality in mice. Symptoms of overdose include diarrhea and skin rash.","approved_countries":["Canada","US"],"id":"compound:CID123631"}],"evidence_label":"A","phenotype":{"type":{"term":"lung adenocarcinoma","id":"DOID:3910"},"description":"lung adenocarcinoma"},"evidence_level":1,"response_type":"resistant"}}
"""  # NOQA

ONCOKB_TEST_MESSAGE = """
{"features":[{"geneSymbol":"EGFR","entrez_id":1956,"name":"Exon 19 deletion/insertion","biomarker_type":"unspecified"}],"tags":[],"genes":["EGFR"],"oncokb":{"clinical":{"level":"1","drugPmids":["15638953","22452895","25589191","23816960","14570950","22285168","20022809","19692680","21670455","18408761","22370314","20573926"],"variant":{"variantResidues":null,"proteinStart":729,"name":"Exon 19 deletion/insertion","proteinEnd":761,"refResidues":null,"alteration":"729_761indel","uniqueId":"EGFR&729_761indel&Exon 19 deletion/insertion&MUTATION&NA&729&761&&","consequence":{"term":"NA","description":"NA","isGenerallyTruncating":false},"gene":{"oncogene":true,"name":"epidermal growth factor receptor","hugoSymbol":"EGFR","entrezGeneId":1956,"tsg":false,"geneAliases":["PIG61","ERBB1","mENA","ERBB","HER1","NISBD2"],"curatedRefSeq":"NM_005228.3","curatedIsoform":"ENST00000275493"}},"drug":["Erlotinib","Afatinib","Gefitinib"],"cancerType":{"code":null,"name":null,"parent":null,"level":null,"color":null,"deprecated":false,"children":{},"links":null,"mainType":{"id":42,"name":"Non-Small Cell Lung Cancer"},"NCI":null,"tissue":null,"UMLS":null,"id":null,"history":[]},"drugAbstracts":[],"level_label":"FDA-approved biomarker and drug in this indication"}},"source":"oncokb","dev_tags":[],"feature_names":"EGFR Exon 19 deletion/insertion","association":{"drug_labels":"Erlotinib,Afatinib,Gefitinib","description":"FDA-approved biomarker and drug in this indication","publication_url":"http://www.ncbi.nlm.nih.gov/pubmed/15638953","evidence":[{"info":{"publications":[[]]},"evidenceType":{"sourceName":"oncokb","id":"EGFR-42"},"description":"1"}],"environmentalContexts":[{"term":"Erlotinib","description":"Erlotinib","taxonomy":{"kingdom":"Organic compounds","direct-parent":"Quinazolinamines","class":"Naphthyridines","subclass":"Quinazolines","superclass":"Organoheterocyclic compounds"},"toxicity":"Symptoms of overdose include diarrhea, rash, and liver transaminase elevation. The most common adverse reactions (>50%) in NSCLC are rash, diarrhea, anorexia and fatigue. The most common adverse reactions (>50%) in pancreatic cancer are fatigue, rash, nausea and anorexia.","approved_countries":["Canada","US"],"id":"compound:CID176870"},{"term":"Afatinib","description":"Afatinib","taxonomy":{"kingdom":"Organic compounds","direct-parent":"Quinazolinamines","class":"Naphthyridines","subclass":"Quinazolines","superclass":"Organoheterocyclic compounds"},"toxicity":"Most common adverse reactions (≥20%) are diarrhea, rash/dermatitis, acneiform, stomatitis, paronychia, dry skin, decreased appetite, pruritus.","approved_countries":["Canada","US"],"id":"compound:CID10184653"},{"term":"Gefitinib","description":"Gefitinib","taxonomy":{"kingdom":"Organic compounds","direct-parent":"Quinazolinamines","class":"Naphthyridines","subclass":"Quinazolines","superclass":"Organoheterocyclic compounds"},"toxicity":"The acute toxicity of gefitinib up to 500 mg in clinical studies has been low. In non-clinical studies, a single dose of 12,000 mg/m<sup>2</sup> (about 80 times the recommended clinical dose on a mg/m<sup>2</sup> basis) was lethal to rats. Half this dose caused no mortality in mice. Symptoms of overdose include diarrhea and skin rash.","approved_countries":["Canada","US"],"id":"compound:CID123631"}],"evidence_label":"A","phenotype":{"type":{"term":"non-small cell lung carcinoma","id":"DOID:3908"},"description":"non-small cell lung carcinoma","id":"42"},"evidence_level":1,"response_type":"NA"}}
"""  # NOQA

MOLECULAR_MATCH_TEST_MESSAGE = """
{"molecularmatch":{"criteriaUnmet":[{"priority":1,"term":"Neoplasm of lung","suppress":false,"filterType":"include","primary":true,"custom":true,"facet":"CONDITION","valid":true,"compositeKey":"Neoplasm of lungCONDITIONinclude"},{"priority":1,"term":"ALK V1180L","suppress":false,"filterType":"include","compositeKey":"ALK V1180LMUTATIONinclude","custom":true,"facet":"MUTATION","valid":true}],"civic":"N/A","mboost":0,"autoGenerateNarrative":true,"mutations":[{"pathology":[],"classification":"actionable","name":"ALK V1180L","wgsaData":{"locations":[{"ExonicFunc":"missense","FullAA":["ALK:NM_004304.4:exon23:c.3538G>C:p.V1180L"],"End":"29443679","PopFreqMax":"0","GERP++_RS":"5.61","_key":"2_29443679_C_G","Transcript":"4CNH:B_1180-B_1268:NM_004304.4","SiPhy_29way_logOdds":"20.0051","FATHMM":"AB","NucleotideChange":"c.3538G>C","FATHMM_Pred":"D","Start":"29443679","Chr":"2","COSMIC_ID":"COSM4381101","Func":"exonic","phyloP100way_vertebrate":"7.768","Alt":"G","Gene":["ALK"],"Ref":"C","phyloP46way_placental":"2.799","Chr_Start_Ref_Alt":"2_29443679_C_G"}]},"description":"","mutation_type":["Missense"],"_src":1,"GRCh38_location":[],"sources":["COSMIC","DoCM"],"synonyms":[],"parents":[{"transcripts":["NM_004304.4"],"type":"exon mutation","name":"ALK exon 23 mutation"},{"transcripts":["NM_004304.4"],"type":"domain","name":"ALK Pkinase_Tyr domain"}],"GRCh37_location":[{"compositeKey":"203924b3e0e5b8727350b4192ca04cea","transcript_consequences":[],"stop":29443679,"start":29443679,"chr":"2","alt":"C","validated":"tute","ref":"G","strand":"-"},{"compositeKey":"e4122d2ba8532ba0a1cd254ebee3a951","transcript_consequences":[{"amino_acid_change":"V1180L","exonNumber":"23","txSites":["NM_004304.4:1180"],"transcript":"NM_004304.4","cdna":"c.3538G>C"}],"stop":29443679,"start":29443679,"chr":"2","alt":"G","validated":"tute","ref":"C","strand":"+","compositeKeyReverse":"2_29443679_G_C"}],"uniprotTranscript":"NM_004304.4","geneSymbol":"ALK","transcripts":[{"CCDS":["CCDS33172.1"],"RefSeq":"NM_004304.4","display":"NM_004304.4 / CCDS33172.1 / ENST00000389048.3","Ensembl":["ENST00000389048.3"]}],"wgsaMap":[{"AA":"p.V1180L","name":"ALK V1180L","GRCh37_Chr_Start_Ref_Alt":"2_29443679_C_G","Synonyms":["ALK p.V1180L","NM_004304.4 p.V1180L","NP_004295.2 p.V1180L","CCDS33172.1 p.V1180L","ENSP00000373700.3 p.V1180L","CCDS33172.1 V1180L","ENST00000389048.3 c.3538G>C","CCDS33172.1 c.3538G>C","ENSP00000373700.3 V1180L","ENSP00000373700.3 c.3538G>C","Q9UM73 V1180L","Q9UM73 c.3538G>C","ENST00000389048.3 p.V1180L","NM_004304.4 V1180L","NM_004304.4 c.3538G>C","Q9UM73 p.V1180L","ENST00000389048.3 V1180L","NP_004295.2 V1180L","NP_004295.2 c.3538G>C"],"ProtCoords":["NM_004304.4:1180"],"NucleotideChange":"c.3538G>C","Exon":"exon23","Gene":"ALK","Transcript":"NM_004304.4"}],"transcript":"NM_004304.4","id":"alk_v1180l","cdna":["c.3538G>C"],"longestTranscript":"NM_004304.4"}],"sources":[{"name":"PUBMED","suppress":false,"pubId":"25736571","link":"https://www.ncbi.nlm.nih.gov/pubmed/25736571","year":"","type":"case_study","id":"1"},{"name":"PUBMED","suppress":false,"pubId":"25228534","subType":"cell_line","link":"https://www.ncbi.nlm.nih.gov/pubmed/25228534","year":"","type":"preclinical","id":"2"}],"clinicalSignificance":"sensitive","id":"lc-108","includeCondition0":["Neoplasia","Neoplasm of respiratory tract","Neoplasm of respiratory system","Malignant neoplastic disease","Solid tumor"],"includeCondition1":["Neoplasm of lung"],"uniqueKey":"8c16b9b01d00244ce14e4334b89f53db","prevalence":[{"count":0,"percent":0,"samples":0,"studyId":"PAN CANCER MAX"},{"count":0,"percent":0,"samples":0,"studyId":"PAN CANCER AVG"}],"regulatoryBodyApproved":true,"version":1,"includeMutation1":["ALK V1180L"],"includeMutation0":["ALK exon 23 mutation","ALK Pkinase_Tyr domain"],"regulatoryBody":"FDA","direction":"supports","ampcap":"1A","ast":{"operator":"&&","right":{"raw":"\\"ALK V1180L\\"","type":"Literal","value":"ALK V1180L"},"type":"LogicalExpression","left":{"raw":"\\"Neoplasm of lung\\"","type":"Literal","value":"Neoplasm of lung"}},"tier":"1","tierExplanation":[{"tier":"1","step":1,"message":"FDA Approved","success":true}],"mvld":"1","tags":[{"priority":1,"term":"Neoplasm of lung","suppress":false,"filterType":"include","primary":true,"custom":true,"facet":"CONDITION","valid":true,"compositeKey":"Neoplasm of lungCONDITIONinclude"},{"priority":1,"term":"ALK V1180L","suppress":false,"filterType":"include","compositeKey":"ALK V1180LMUTATIONinclude","custom":true,"facet":"MUTATION","valid":true},{"priority":0,"term":"ALK","suppress":false,"generatedBy":"MUTATION","filterType":"include","custom":false,"facet":"GENE","generatedByTerm":"ALK V1180L"},{"priority":0,"term":"ALK exon 23 mutation","suppress":false,"generatedBy":"MUTATION","filterType":"include","custom":false,"facet":"MUTATION","generatedByTerm":"ALK V1180L"},{"priority":0,"term":"ALK Pkinase_Tyr domain","suppress":false,"generatedBy":"MUTATION","filterType":"include","custom":false,"facet":"MUTATION","generatedByTerm":"ALK V1180L"},{"priority":0,"term":"Neoplasia","suppress":false,"generatedBy":"CONDITION","filterType":"include","custom":false,"facet":"CONDITION","generatedByTerm":"Neoplasm of lung"},{"priority":0,"term":"Neoplasm of respiratory tract","suppress":false,"generatedBy":"CONDITION","filterType":"include","custom":false,"facet":"CONDITION","generatedByTerm":"Neoplasm of lung"},{"priority":0,"term":"Neoplasm of respiratory system","suppress":false,"generatedBy":"CONDITION","filterType":"include","custom":false,"facet":"CONDITION","generatedByTerm":"Neoplasm of lung"},{"priority":0,"term":"Malignant neoplastic disease","suppress":false,"generatedBy":"CONDITION","filterType":"include","custom":false,"facet":"CONDITION","generatedByTerm":"Neoplasm of lung"},{"priority":0,"term":"Solid tumor","suppress":false,"generatedBy":"CONDITION","filterType":"include","custom":false,"facet":"CONDITION","generatedByTerm":"Neoplasm of lung"},{"priority":0,"term":"Lung","suppress":false,"generatedBy":"CONDITION","filterType":"include","custom":false,"facet":"SITE","generatedByTerm":"Neoplasm of lung"}],"customer":"MolecularMatch","biomarkerClass":"predictive","classifications":[{"name":"ALK V1180L","classification":"actionable"}],"therapeuticContext":[{"facet":"DRUG","suppress":false,"valid":true,"name":"Ceritinib"}],"includeDrug1":["Ceritinib"],"sixtier":"1","narrative":"ALK V1180L confers sensitivity to Ceritinib in patients with Neoplasm of lung","expression":"\\"Neoplasm of lung\\" && \\"ALK V1180L\\"","includeGene0":["ALK"]},"features":[{"name":"ALK V1180L","start":29443679,"biomarker_type":"snp","geneSymbol":"ALK","alt":"C","ref":"G","chromosome":"2"}],"tags":[],"genes":["ALK"],"source":"molecularmatch","dev_tags":["no-doid"],"feature_names":"ALK V1180L","association":{"drug_labels":"Ceritinib","description":"ALK V1180L confers sensitivity to Ceritinib in patients with Neoplasm of lung","publication_url":"https://www.ncbi.nlm.nih.gov/pubmed/25736571","evidence":[{"info":{"publications":["https://www.ncbi.nlm.nih.gov/pubmed/25736571","https://www.ncbi.nlm.nih.gov/pubmed/25228534"]},"evidenceType":{"sourceName":"molecularmatch"},"description":"ALK V1180L confers sensitivity to Ceritinib in patients with Neoplasm of lung"}],"environmentalContexts":[{"term":"Ceritinib","toxicity":"There is not currently any data on carcinogenicity, effect on human fertility, or on early embryonic development. However, based on its mechanism of action, ceritinib may cause fetal harm when administered to pregnant women and should therefore be administered with effective contraception during treatment. Diarrhea, nausea, vomiting, or abdominal pain occurred in 96% of 255 patients including severe cases in 14% of patients. Drug-induced hepatotoxicity also occurred in 27% of 255 patients, presenting as alanine aminotransferase (ALT) levels greater than 5 times the upper limit of normal (ULN). Severe, life-threatening, or fatal interstitial lung disease (ILD)/pneumonitis, hyperglycaemia, and bradycardia have also been reported.","approved_countries":["Canada","US"],"id":"compound:CID57379345","description":"Ceritinib"}],"evidence_label":"A","phenotype":{"description":"Solid tumor"},"evidence_level":1,"response_type":"1"}}
"""  # NOQA

CGI_TEST_MESSAGE = """
{"cgi":{"Targeting":"","Biomarker":"ABL1 (F359V,F359C,F359I,Y253H,E255K,E255V)","Source":"PMID:21562040","cDNA":"c.764A>T","Primary Tumor type":"CML","individual_mutation":"ABL1:p.E255V","Drug full name":"Dasatinib (BCR-ABL inhibitor 2nd gen)","Association":"Responsive","Drug family":"BCR-ABL inhibitor 2nd gen","Curator":"RDientsmann","Drug":"Dasatinib","Alteration":"ABL1:F359V,F359C,F359I,Y253H,E255K,E255V","gDNA":"chr9:g.133738364A>T","Drug status":"Approved","Gene":"ABL1","transcript":"ENST00000318560","strand":"+","info":"CSQN=Missense;reference_codon=GAG;candidate_codons=GTA,GTC,GTG,GTT;candidate_mnv_variants=chr9:g.133738364_133738365delAGinsTA,chr9:g.133738364_133738365delAGinsTC,chr9:g.133738364_133738365delAGinsTT;aliases=ENSP00000323315;source=Ensembl","Assay type":"","Alteration type":"MUT","region":"inside_[cds_in_exon_4]","Evidence level":"NCCN guidelines","gene":"ABL1","Metastatic Tumor Type":""},"features":[{"name":"ABL1:p.E255V","start":"133738364","biomarker_type":"snp","geneSymbol":"ABL1","alt":"T","ref":"A","chromosome":"9","description":"ABL1:F359V,F359C,F359I,Y253H,E255K,E255V"}],"tags":[],"genes":["ABL1"],"source":"cgi","dev_tags":[],"feature_names":"ABL1 (F359V,F359C,F359I,Y253H,E255K,E255V)","association":{"drug_labels":"Dasatinib","description":"ABL1 Dasatinib (BCR-ABL inhibitor 2nd gen) Responsive","publication_url":"http://www.ncbi.nlm.nih.gov/pubmed/21562040","evidence":[{"info":{"publications":["http://www.ncbi.nlm.nih.gov/pubmed/21562040"]},"evidenceType":{"sourceName":"cgi"},"description":"Responsive"}],"environmentalContexts":[{"term":"Dasatinib","description":"Dasatinib","taxonomy":{"kingdom":"Organic compounds","direct-parent":"N-arylpiperazines","class":"Diazinanes","subclass":"Piperazines","superclass":"Organoheterocyclic compounds"},"toxicity":"Acute overdose in animals was associated with cardiotoxicity.","approved_countries":["Canada","US"],"id":"compound:CID3062316"}],"evidence_label":"A","phenotype":{"type":{"term":"chronic myeloid leukemia","id":"DOID:8552"},"description":"chronic myeloid leukemia"},"evidence_level":1,"response_type":"Responsive"}}
"""  # NOQA

PMKB_TEST_MESSAGE = """
{"features":[{"end":"25398285","name":"KRAS codon(s) 12, 13, 61, 117, 146 any","start":"25398283","biomarker_type":"unspecified","referenceName":"GRCh37/hg19","geneSymbol":"KRAS","attributes":{"amino_acid_change":{"string_value":null},"germline":{"string_value":null},"partner_gene":{"string_value":null},"description":{"string_value":null},"exons":{"string_value":"2, 2, 3, 4, 4"},"notes":{"string_value":null},"cosmic":{"string_value":null},"effect":{"string_value":null},"cnv_type":{"string_value":null},"id":{"string_value":283},"cytoband":{"string_value":null},"variant_type":{"string_value":"any"},"dna_change":{"string_value":null},"codons":{"string_value":"12, 13, 61, 117, 146"},"chromosome_based_cnv":{"string_value":false},"transcript":{"string_value":"ENST00000256078"},"description_type":{"string_value":"codon"},"chromosome":{"string_value":null}},"chromosome":"12"}],"tags":[],"genes":["KRAS"],"source":"pmkb","pmkb":{"tumor":{"id":120,"name":"T Lymphoblastic Leukemia/Lymphoma"},"tissues":[{"id":7,"name":"Blood"},{"id":9,"name":"Bone Marrow"}],"variant":{"amino_acid_change":null,"germline":null,"partner_gene":null,"description":null,"exons":"2, 2, 3, 4, 4","cnv_type":null,"notes":null,"cosmic":null,"effect":null,"coordinates":"12:25398283-25398285, 12:25398280-25398282, 12:25380275-25380277, 12:25378647-25378649, 12:25378560-25378562","description_type":"codon","cytoband":null,"variant_type":"any","dna_change":null,"codons":"12, 13, 61, 117, 146","chromosome_based_cnv":false,"gene":{"updated_at":"2015-12-09T20:08:35.000Z","created_at":"2015-12-09T20:08:35.000Z","description":null,"id":50,"name":"KRAS"},"transcript":"ENST00000256078","id":283,"chromosome":null,"name":"KRAS codon(s) 12, 13, 61, 117, 146 any"}},"dev_tags":["no-doid"],"feature_names":"KRAS KRAS codon(s) 12, 13, 61, 117, 146 any","association":{"drug_labels":"NA","description":"KRAS is a well known proto-oncogene that belongs to the small GTPase family.  Pathogenic  mutations in KRAS typically occur in codons 12-13 of exon 2 and codon 61 of exon 3; however, other, non-canonical,  pathogenic mutations in KRAS have also been reported in acute myeoid leukemia.  KRAS mutations have been described in approximately 3-15% of acute myeloid leukemia, 8-20% of chronic myelomonocytic leukemia, 4% of patients with myelodysplastic syndrome, 12% of B cell acute lymphoblastic leukemia(often associated with MLL rearrangement) and 1-2% of T cell acute lymphoblastic leukemia. Investigation into the targetability of this pathway in leukemia has been attempted in some disease models.", "publication_url":"http://www.ncbi.nlm.nih.gov/pubmed/24166518","evidence":[{"info":{"publications":[["http://www.ncbi.nlm.nih.gov/pubmed/24166518","http://www.ncbi.nlm.nih.gov/pubmed/24105326","http://www.ncbi.nlm.nih.gov/pubmed/23690417","http://www.ncbi.nlm.nih.gov/pubmed/19075190","http://www.ncbi.nlm.nih.gov/pubmed/16404744","http://www.ncbi.nlm.nih.gov/pubmed/23512829","http://www.ncbi.nlm.nih.gov/pubmed/24569456"]]},"evidenceType":{"sourceName":"pmkb"},"description":"1"}],"evidence_label":"A","phenotype":{"description":"T Lymphoblastic Leukemia/Lymphoma"},"evidence_level":1,"response_type":"NA"}}
"""  # NOQA


def test_pmkb_pb():
    """ ensure we can de-serialize the message """
    harvested_evidence = json_format.Parse(
                                        PMKB_TEST_MESSAGE,
                                        evidence.Evidence(),
                                        ignore_unknown_fields=True)
    assert harvested_evidence.genes == ["KRAS"]
    assert harvested_evidence.source == "pmkb"
    assert harvested_evidence.features[-1].end == 25398285
    assert 'KRAS is a well known proto-oncogene' in \
        harvested_evidence.association.description
    assert harvested_evidence.pmkb


def test_civic_pb():
    """ ensure we can de-serialize the message """
    harvested_evidence = json_format.Parse(
                                        CIVIC_TEST_MESSAGE,
                                        evidence.Evidence(),
                                        ignore_unknown_fields=True)
    assert harvested_evidence.genes == ["DPYD"]
    assert harvested_evidence.source == "civic"
    assert harvested_evidence.features[-1].end == 97915614
    assert 'Guidelines for DPYD genotype and 5-FU' \
        in harvested_evidence.association.description
    assert harvested_evidence.civic
    harvested_evidence.civic['evidence_items'][0]["clinical_significance"] == \
        "Better Outcome"


def test_jax_pb():
    """ ensure we can de-serialize the message """
    harvested_evidence = json_format.Parse(
                                        JAX_TEST_MESSAGE,
                                        evidence.Evidence(),
                                        ignore_unknown_fields=True)
    assert harvested_evidence.genes == ["KRAS"]
    assert harvested_evidence.source == "jax"
    assert harvested_evidence.features[-1].name == "KRAS"
    assert 'lung adenocarcinoma patients with KRAS codon 12 or 13' \
           in harvested_evidence.association.description
    assert harvested_evidence.jax
    harvested_evidence.jax['approval_status'] == 'Preclinical'


def test_oncokb_pb():
    """ ensure we can de-serialize the message """
    harvested_evidence = json_format.Parse(
                                        ONCOKB_TEST_MESSAGE,
                                        evidence.Evidence(),
                                        ignore_unknown_fields=True)
    assert harvested_evidence.genes == ['EGFR']
    assert harvested_evidence.source == "oncokb"
    assert harvested_evidence.features[-1].name == 'Exon 19 deletion/insertion'
    assert 'FDA-approved biomarker and drug in this indication' \
        in harvested_evidence.association.description
    assert harvested_evidence.oncokb
    assert harvested_evidence.oncokb['clinical']['cancerType']['mainType']['name'] == 'Non-Small Cell Lung Cancer'  # NOQA


def test_molecular_match_pb():
    """ ensure we can de-serialize the message """
    harvested_evidence = json_format.Parse(
                                        MOLECULAR_MATCH_TEST_MESSAGE,
                                        evidence.Evidence(),
                                        ignore_unknown_fields=True)
    assert harvested_evidence.genes == ["ALK"]
    assert harvested_evidence.source == "molecularmatch"
    assert harvested_evidence.features[-1].name == "ALK V1180L"
    assert 'ALK V1180L confers sensitivity to Ceritinib' in \
        harvested_evidence.association.description
    assert harvested_evidence.molecularmatch['clinicalSignificance'] == 'sensitive'  # NOQA


def test_cgi_pb():
    """ ensure we can de-serialize the message """
    harvested_evidence = json_format.Parse(
                                        CGI_TEST_MESSAGE,
                                        evidence.Evidence(),
                                        ignore_unknown_fields=True)
    assert harvested_evidence.genes == ["ABL1"]
    assert harvested_evidence.source == "cgi"
    assert harvested_evidence.features[-1].name == "ABL1:p.E255V"
    assert 'ABL1 Dasatinib (BCR-ABL inhibitor 2nd gen) Responsive' in \
        harvested_evidence.association.description
    assert harvested_evidence.cgi['Gene'] == 'ABL1'
